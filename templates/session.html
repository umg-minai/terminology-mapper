{% extends "base.html" %}

{% block title %}Mapping Session - Medical Term Mapper{% endblock %}

{% block content %}
<div class="session-container">
    <!-- Progress Header -->
    <div class="session-header">
        <h2>Mapping Session</h2>
        <div class="session-progress">
            <span class="progress-label">Term {{ current }} of {{ total }}</span>
            <div class="progress-bar-container">
                <div class="progress-bar progress-bar-animated" style="width: {{ progress }}%"></div>
            </div>
        </div>
    </div>

    <!-- Current Term Card -->
    <div class="card term-card">
        <div class="term-display">
            <div class="term-category">{{ term.category }}</div>
            <div class="term-text">{{ term.term }}</div>
        </div>

        <form method="POST" action="/session/submit" id="mappingForm">
            <!-- Codes List -->
            <div id="codesContainer">
                <!-- Initial code entry -->
                <div class="code-entry" data-index="0">
                    <div class="code-entry-header">
                        <label>Concept #1</label>
                    </div>
                    <div class="code-entry-body">
                        <div class="form-row">
                            <div class="form-group flex-grow">
                                <label class="input-label">Code <span class="help-text">(unique identifier)</span></label>
                                <input type="text" class="code-input" data-code-index="0"
                                       placeholder="e.g., 123456789, I10, LP12345-6"
                                       autofocus>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group flex-grow">
                                <label class="input-label">Display Text <span class="help-text">(human-readable description)</span></label>
                                <input type="text" class="display-text-input" data-display-index="0"
                                       placeholder="e.g., Essential (primary) hypertension">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="vocab-selector">
                                <label class="vocab-label">Vocabulary:</label>
                                <div class="radio-group">
                                    <label class="radio-option">
                                        <input type="radio" name="vocab_0" value="SNOMED" checked>
                                        <span>SNOMED CT</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="vocab_0" value="ICD10">
                                        <span>ICD-10</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="vocab_0" value="LOINC">
                                        <span>LOINC</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="vocab_0" value="OTHER" class="vocab-other-radio" data-vocab-index="0">
                                        <span>Other</span>
                                    </label>
                                </div>
                                <div class="vocab-other-input" data-vocab-index="0" style="display: none; margin-top: 10px;">
                                    <input type="text" class="vocab-other-text" data-vocab-index="0"
                                           placeholder="Enter vocabulary name (required)" 
                                           style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px;">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <label class="checkbox-option">
                                <input type="checkbox" class="approximate-match-checkbox" data-approx-index="0">
                                <span>Approximate match</span>
                            </label>
                            <span class="help-text" style="margin-left: 10px;">Check if the code doesn't exactly match the term</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Another Code Button -->
            <button type="button" class="btn btn-secondary btn-add-code" id="addCodeBtn">
                + Add Another Concept
            </button>

            <!-- Comment Field -->
            <div class="form-group" style="margin-top: 20px;">
                <label for="comment">Optional Comment:</label>
                <textarea id="comment" name="comment" rows="3" 
                          placeholder="Add any comments or notes about this term (optional)"
                          style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 4px; font-family: inherit; font-size: 14px;"></textarea>
            </div>

            <!-- Hidden inputs to store JSON data -->
            <input type="hidden" name="codes_json" id="codesJson">
            <input type="hidden" name="display_texts_json" id="displayTextsJson">
            <input type="hidden" name="no_code_found" id="noCodeFound" value="false">
            <input type="hidden" name="propose_new" id="proposeNew" value="false">

            <div class="button-group">
                <button type="submit" class="btn btn-primary btn-large" id="submitBtn">
                    Submit & Continue
                </button>
                <button type="button" class="btn btn-warning btn-large" id="noCodeBtn">
                    No Code Found - Propose New Concept
                </button>
            </div>
            
            <div class="help-banner" style="margin-top: 15px; padding: 12px; background: #f1f5f9; border-left: 4px solid #3b82f6; border-radius: 4px;">
                <p style="margin: 0; font-size: 14px;"><strong>Need help?</strong> Check out the <a href="/manual" target="_blank" style="color: #3b82f6; text-decoration: underline;">mapping manual</a> for detailed instructions.</p>
            </div>
        </form>

        <!-- Additional Info -->
        <div class="info-banner">
            <p><strong>Current mappings for this term:</strong> {{ term.mapping_count }}</p>
            {% if term.mapping_count < required_raters %}
            <p class="highlight">This term needs more mappings!</p>
            {% endif %}
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="session-stats">
        <div class="stat-mini">
            <span class="label">Completed:</span>
            <span class="value">{{ current - 1 }}</span>
        </div>
        <div class="stat-mini">
            <span class="label">Remaining:</span>
            <span class="value">{{ total - current + 1 }}</span>
        </div>
    </div>
</div>

<script>
let codeCount = 1;

// Auto-detect vocabulary based on code pattern
function detectVocabulary(code) {
    code = code.trim();

    // SNOMED CT: typically 6-18 digits
    if (/^\d{6,18}$/.test(code)) {
        return 'SNOMED';
    }

    // ICD-10: starts with letter, followed by 2 digits, optional dot and more chars
    // Examples: I10, E11.9, S72.001A
    if (/^[A-TV-Z]\d{2}(\.\d{1,4}[A-Z]?)?$/i.test(code)) {
        return 'ICD10';
    }

    // LOINC: typically LP or just digits followed by dash and digit
    // Examples: LP12345-6, 1234-5
    if (/^(LP)?\d{4,6}-\d$/i.test(code)) {
        return 'LOINC';
    }

    return null;
}

// Add event listeners to code inputs for auto-detection
function setupCodeInput(index) {
    const input = document.querySelector(`input.code-input[data-code-index="${index}"]`);
    const radios = document.querySelectorAll(`input[name="vocab_${index}"]`);

    input.addEventListener('input', function() {
        const detected = detectVocabulary(this.value);
        if (detected) {
            radios.forEach(radio => {
                if (radio.value === detected) {
                    radio.checked = true;
                }
            });
        }
    });
}

// Setup initial input
setupCodeInput(0);

// Setup vocabulary "Other" option toggle
function setupVocabOtherToggle(index) {
    const otherRadio = document.querySelector(`input.vocab-other-radio[data-vocab-index="${index}"]`);
    const otherInput = document.querySelector(`.vocab-other-input[data-vocab-index="${index}"]`);
    const allRadios = document.querySelectorAll(`input[name="vocab_${index}"]`);

    allRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'OTHER') {
                otherInput.style.display = 'block';
                otherInput.querySelector('.vocab-other-text').focus();
            } else {
                otherInput.style.display = 'none';
                otherInput.querySelector('.vocab-other-text').value = '';
            }
        });
    });
}

// Setup initial vocabulary toggle
setupVocabOtherToggle(0);

// Add another code entry
document.getElementById('addCodeBtn').addEventListener('click', function() {
    const container = document.getElementById('codesContainer');
    const newIndex = codeCount;

    const newEntry = document.createElement('div');
    newEntry.className = 'code-entry';
    newEntry.dataset.index = newIndex;
    newEntry.innerHTML = `
        <div class="code-entry-header">
            <label>Concept #${newIndex + 1}</label>
            <button type="button" class="btn-remove-code" data-remove-index="${newIndex}">Remove</button>
        </div>
        <div class="code-entry-body">
            <div class="form-row">
                <div class="form-group flex-grow">
                    <label class="input-label">Code <span class="help-text">(unique identifier)</span></label>
                    <input type="text" class="code-input" data-code-index="${newIndex}"
                           placeholder="e.g., 123456789, I10, LP12345-6">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group flex-grow">
                    <label class="input-label">Display Text <span class="help-text">(human-readable description)</span></label>
                    <input type="text" class="display-text-input" data-display-index="${newIndex}"
                           placeholder="e.g., Essential (primary) hypertension">
                </div>
            </div>
            <div class="form-row">
                <div class="vocab-selector">
                    <label class="vocab-label">Vocabulary:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="vocab_${newIndex}" value="SNOMED" checked>
                            <span>SNOMED CT</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="vocab_${newIndex}" value="ICD10">
                            <span>ICD-10</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="vocab_${newIndex}" value="LOINC">
                            <span>LOINC</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="vocab_${newIndex}" value="OTHER" class="vocab-other-radio" data-vocab-index="${newIndex}">
                            <span>Other</span>
                        </label>
                    </div>
                    <div class="vocab-other-input" data-vocab-index="${newIndex}" style="display: none; margin-top: 10px;">
                        <input type="text" class="vocab-other-text" data-vocab-index="${newIndex}"
                               placeholder="Enter vocabulary name (required)" 
                               style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px;">
                    </div>
                </div>
            </div>
            <div class="form-row">
                <label class="checkbox-option">
                    <input type="checkbox" class="approximate-match-checkbox" data-approx-index="${newIndex}">
                    <span>Approximate match</span>
                </label>
                <span class="help-text" style="margin-left: 10px;">Check if the code doesn't exactly match the term</span>
            </div>
        </div>
    `;

    container.appendChild(newEntry);
    setupCodeInput(newIndex);
    setupVocabOtherToggle(newIndex);

    // Setup remove button
    newEntry.querySelector('.btn-remove-code').addEventListener('click', function() {
        newEntry.remove();
    });

    codeCount++;

    // Focus on new input
    newEntry.querySelector('.code-input').focus();
});

// Handle "No Code Found" button - propose new concept
document.getElementById('noCodeBtn').addEventListener('click', function() {
    const displayText = prompt('No existing code found. Please propose a new concept by entering a display text (description):');
    
    if (displayText && displayText.trim()) {
        // User is proposing a new concept - only display text, no code
        const newConcept = [{
            code: '',
            display_text: displayText.trim(),
            vocabulary: 'NEW_CONCEPT',
            approximate_match: false
        }];
        
        document.getElementById('codesJson').value = JSON.stringify(newConcept);
        document.getElementById('displayTextsJson').value = JSON.stringify([displayText.trim()]);
        document.getElementById('noCodeFound').value = 'true';
        document.getElementById('proposeNew').value = 'true';
        document.getElementById('mappingForm').submit();
    } else if (displayText !== null) {
        // User clicked OK but didn't enter text
        alert('Please enter a description for the new concept, or click Cancel if you changed your mind.');
    }
    // If null (clicked Cancel), do nothing
});

// Handle form submission
document.getElementById('mappingForm').addEventListener('submit', function(e) {
    e.preventDefault();

    // Collect all codes and display texts
    const codes = [];
    const displayTexts = [];
    const codeEntries = document.querySelectorAll('.code-entry');
    let validationError = false;

    codeEntries.forEach(entry => {
        const index = entry.dataset.index;
        const codeInput = entry.querySelector(`input.code-input[data-code-index="${index}"]`);
        const displayTextInput = entry.querySelector(`input.display-text-input[data-display-index="${index}"]`);
        const vocabRadio = entry.querySelector(`input[name="vocab_${index}"]:checked`);
        const approxCheckbox = entry.querySelector(`input.approximate-match-checkbox[data-approx-index="${index}"]`);

        const code = codeInput.value.trim();
        const displayText = displayTextInput.value.trim();
        
        if (code || displayText) {
            let vocabulary = vocabRadio ? vocabRadio.value : 'SNOMED';
            
            // If "Other" is selected, get the custom vocabulary name
            if (vocabulary === 'OTHER') {
                const otherInput = entry.querySelector(`.vocab-other-text[data-vocab-index="${index}"]`);
                const otherValue = otherInput ? otherInput.value.trim() : '';
                
                if (!otherValue) {
                    alert('Please enter a vocabulary name for "Other" or select a different vocabulary option.');
                    otherInput.focus();
                    validationError = true;
                    return;
                }
                
                vocabulary = otherValue;
            }
            
            codes.push({
                code: code,
                vocabulary: vocabulary,
                approximate_match: approxCheckbox ? approxCheckbox.checked : false
            });
            
            displayTexts.push(displayText);
        }
    });

    if (validationError) {
        return;
    }

    // Set the JSON data
    document.getElementById('codesJson').value = JSON.stringify(codes);
    document.getElementById('displayTextsJson').value = JSON.stringify(displayTexts);
    document.getElementById('noCodeFound').value = 'false';
    document.getElementById('proposeNew').value = 'false';

    // Submit the form
    this.submit();
});

// Prevent Enter key from submitting the form
document.getElementById('mappingForm').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.ctrlKey) {
        e.preventDefault();
        return false;
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+Enter to submit
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('submitBtn').click();
    }

    // Ctrl+N for no code found
    if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        document.getElementById('noCodeBtn').click();
    }
});

// Store form data in sessionStorage before navigation
function saveFormData() {
    const termId = '{{ term.id }}';
    const formData = {
        codes: [],
        comment: document.getElementById('comment').value
    };
    
    document.querySelectorAll('.code-entry').forEach(entry => {
        const index = entry.dataset.index;
        const codeInput = entry.querySelector(`input.code-input[data-code-index="${index}"]`);
        const displayTextInput = entry.querySelector(`input.display-text-input[data-display-index="${index}"]`);
        const vocabRadio = entry.querySelector(`input[name="vocab_${index}"]:checked`);
        const approxCheckbox = entry.querySelector(`input.approximate-match-checkbox[data-approx-index="${index}"]`);
        
        let vocabulary = vocabRadio ? vocabRadio.value : 'SNOMED';
        if (vocabulary === 'OTHER') {
            const otherInput = entry.querySelector(`.vocab-other-text[data-vocab-index="${index}"]`);
            vocabulary = otherInput ? otherInput.value.trim() : '';
        }
        
        formData.codes.push({
            code: codeInput.value,
            displayText: displayTextInput.value,
            vocabulary: vocabulary,
            approximateMatch: approxCheckbox ? approxCheckbox.checked : false
        });
    });
    
    sessionStorage.setItem(`term_draft_${termId}`, JSON.stringify(formData));
}

// Restore form data from sessionStorage
function restoreFormData() {
    const termId = '{{ term.id }}';
    const savedData = sessionStorage.getItem(`term_draft_${termId}`);
    
    if (savedData) {
        const formData = JSON.parse(savedData);
        
        // Restore comment
        if (formData.comment) {
            document.getElementById('comment').value = formData.comment;
        }
        
        // Restore code entries
        if (formData.codes && formData.codes.length > 0) {
            // Clear default entry
            const container = document.getElementById('codesContainer');
            container.innerHTML = '';
            
            formData.codes.forEach((codeData, index) => {
                if (index > 0) {
                    // Add additional entries
                    document.getElementById('addCodeBtn').click();
                }
                
                // Wait for DOM to update
                setTimeout(() => {
                    const entry = container.querySelector(`[data-index="${index}"]`);
                    if (!entry) {
                        // Create the entry manually
                        createCodeEntry(index);
                    }
                    
                    const codeInput = container.querySelector(`input.code-input[data-code-index="${index}"]`);
                    const displayTextInput = container.querySelector(`input.display-text-input[data-display-index="${index}"]`);
                    const approxCheckbox = container.querySelector(`input.approximate-match-checkbox[data-approx-index="${index}"]`);
                    
                    if (codeInput) codeInput.value = codeData.code || '';
                    if (displayTextInput) displayTextInput.value = codeData.displayText || '';
                    if (approxCheckbox) approxCheckbox.checked = codeData.approximateMatch || false;
                    
                    // Set vocabulary
                    const vocabRadios = container.querySelectorAll(`input[name="vocab_${index}"]`);
                    let vocabSet = false;
                    vocabRadios.forEach(radio => {
                        if (radio.value === codeData.vocabulary) {
                            radio.checked = true;
                            vocabSet = true;
                        }
                    });
                    
                    // If custom vocabulary, set Other and the text field
                    if (!vocabSet && codeData.vocabulary) {
                        const otherRadio = container.querySelector(`input.vocab-other-radio[data-vocab-index="${index}"]`);
                        if (otherRadio) {
                            otherRadio.checked = true;
                            const otherInput = container.querySelector(`.vocab-other-input[data-vocab-index="${index}"]`);
                            if (otherInput) {
                                otherInput.style.display = 'block';
                                const textInput = otherInput.querySelector('.vocab-other-text');
                                if (textInput) textInput.value = codeData.vocabulary;
                            }
                        }
                    }
                }, 100 * index);
            });
        }
    }
}

function createCodeEntry(index) {
    const container = document.getElementById('codesContainer');
    const newEntry = document.createElement('div');
    newEntry.className = 'code-entry';
    newEntry.dataset.index = index;
    newEntry.innerHTML = `
        <div class="code-entry-header">
            <label>Concept #${index + 1}</label>
            ${index > 0 ? `<button type="button" class="btn-remove-code" data-remove-index="${index}">Remove</button>` : ''}
        </div>
        <div class="code-entry-body">
            <div class="form-row">
                <div class="form-group flex-grow">
                    <label class="input-label">Code <span class="help-text">(unique identifier)</span></label>
                    <input type="text" class="code-input" data-code-index="${index}"
                           placeholder="e.g., 123456789, I10, LP12345-6"${index === 0 ? ' autofocus' : ''}>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group flex-grow">
                    <label class="input-label">Display Text <span class="help-text">(human-readable description)</span></label>
                    <input type="text" class="display-text-input" data-display-index="${index}"
                           placeholder="e.g., Essential (primary) hypertension">
                </div>
            </div>
            <div class="form-row">
                <div class="vocab-selector">
                    <label class="vocab-label">Vocabulary:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="vocab_${index}" value="SNOMED" checked>
                            <span>SNOMED CT</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="vocab_${index}" value="ICD10">
                            <span>ICD-10</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="vocab_${index}" value="LOINC">
                            <span>LOINC</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="vocab_${index}" value="OTHER" class="vocab-other-radio" data-vocab-index="${index}">
                            <span>Other</span>
                        </label>
                    </div>
                    <div class="vocab-other-input" data-vocab-index="${index}" style="display: none; margin-top: 10px;">
                        <input type="text" class="vocab-other-text" data-vocab-index="${index}"
                               placeholder="Enter vocabulary name (required)" 
                               style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px;">
                    </div>
                </div>
            </div>
            <div class="form-row">
                <label class="checkbox-option">
                    <input type="checkbox" class="approximate-match-checkbox" data-approx-index="${index}">
                    <span>Approximate match</span>
                </label>
                <span class="help-text" style="margin-left: 10px;">Check if the code doesn't exactly match the term</span>
            </div>
        </div>
    `;
    container.appendChild(newEntry);
    setupCodeInput(index);
    setupVocabOtherToggle(index);
    
    if (index > 0) {
        newEntry.querySelector('.btn-remove-code')?.addEventListener('click', function() {
            newEntry.remove();
        });
    }
}

// Save form data periodically and before navigation
setInterval(saveFormData, 2000);
window.addEventListener('beforeunload', saveFormData);

// Restore form data on page load
restoreFormData();
</script>
{% endblock %}
